---
title: Visualización de la información
subtitle: Práctica independiente
output:
  html_notebook: 
    toc: true
    toc_float: true 
---

# Ejercicios para practicar
1. Calcular el promedio del ingreso por ocupación principal (Variable **P21**)  para  **asalariados** con y sin **descuento jubilatorio** (Variable **PP07H**). Luego realizar un gráfico de barras donde se comparen ambos valores (para el 1er trimestre de 2017).                   
```{r}
library(tidyverse) 
library(ggthemes)  
library(ggrepel)   
library(scales)
library(eph)


Individual_t117 <- get_microdata(2017, trimester = 1, type = "individual")

Individual_t117 %>% 
  filter(P21>0, ESTADO==1 ,CAT_OCUP==3) %>% 
  mutate(Proteccion = as.factor(case_when(PP07H == 1  ~ 'Protegido', 
                                          PP07H == 2  ~ 'Desprotegido'))) %>% 
        
  group_by(Proteccion) %>% 
  summarise(Prom_Ingre = weighted.mean(P21,PONDIIO)) %>% 

ggplot(data = ., aes(x=Proteccion, y=Prom_Ingre,fill= Proteccion))+
       geom_col(alpha=0.75)+
       labs(title = "Promedio de ingresos por nivel de proteccion")+
       theme(legend.position = "none")+
       theme_classic()


```
  
  
   Pistas: Se deben filtrar previamente los ingresos mayores a 0 (**P21>0**).Chequear que ponderador corresponde utilizar           
               
1. Graficar la distribución del ingreso por ocupación principal para Asalariados, Cuentapropistas y Patrones, con el tipo de gráfico Kernel                 
   Pista: Usar la función **facet_wrap** para separar a cada una de las categorías ocupacionales)                
   Sugerencia: incorporar la línea ``` scale_x_continuous(limits = c(0,50000)) ``` entre las capas del gráfico. ¿Qué cambió?
   
```{r}
library(ggridges)

Individual_t117 %>% 
  select(P21, CAT_OCUP, PONDIIO) %>% 
  filter(P21>0) %>% 
  mutate(CAT_OCUP = as.factor(case_when(CAT_OCUP == 1 ~ "Patrón",
                                        CAT_OCUP == 2 ~ "Cuenta propia",
                                        CAT_OCUP == 3 ~ "Asalariado",
                                        TRUE         ~ "RESTO"))) %>% 

ggplot(data = ., aes(x=P21, y=CAT_OCUP, weights = PONDIIO, fill= CAT_OCUP))+
    geom_density_ridges()+
    scale_x_continuous(limits = c(0,50000))

```

OPCION 2

```{r}
Individual_t117 %>% 
  select(P21, CAT_OCUP, PONDIIO) %>% 
  filter(P21>0) %>% 
  mutate(CAT_OCUP = as.factor(case_when(CAT_OCUP == 1 ~ "Patrón",
                                        CAT_OCUP == 2 ~ "Cuenta propia",
                                        CAT_OCUP == 3 ~ "Asalariado",
                                        TRUE         ~ "RESTO"))) %>% 

ggplot(data = ., aes(x=P21, weights = PONDIIO, fill= CAT_OCUP))+
    geom_density(alpha=0.6)+
    scale_x_continuous(limits = c(0,50000))+
    facet_wrap(~CAT_OCUP)
```


1. Hacer un gráfico boxplot de la distribución de edades de los asalariados con descuento jubilatorio, y de los asalariados sin descuento jubilatorio.

```{r}
Individual_t117 %>% 
  filter(P21>0, ESTADO==1 ,CAT_OCUP==3) %>% 
  mutate(Proteccion = as.factor(case_when(PP07H == 1  ~ 'Asalariado con descuentos', 
                                          PP07H == 2  ~ 'Asalariado sin descuentos'))) %>% 

  ggplot(., aes(x = Proteccion, y = CH06, fill=Proteccion)) +
      geom_boxplot()+
      theme(legend.position = "none")+
      labs(y="Edad")


```


1. Uniendo las bases de los distintos trimestres, calcular el procentaje de asalariados sin descuento jubilatorio como $\frac{Asal. s/ desc jubil}{Asal. c/ desc jubil+ Asal.s/ desc jubil}$. Luego realizar un gráfico de linea con la evolución de este indicador

```{r}
Individual_t216 <-
  read.table("../Fuentes/usu_individual_t216.txt",
             sep = ";",
             dec = ",",
             header = TRUE,
             fill = TRUE )

Individual_t316 <-
  read.table("../Fuentes/usu_individual_t316.txt",
             sep = ";",
             dec = ",",
             header = TRUE,
             fill = TRUE )

Individual_t416 <-
  read.table("../Fuentes/usu_individual_t416.txt",
             sep = ";",
             dec = ",",
             header = TRUE,
             fill = TRUE )

GRANBASE <- bind_rows(Individual_t216,
                      Individual_t316,
                      Individual_t416,
                      Individual_t117)
GRANBASE %>% 
  filter(ESTADO==1 ,CAT_OCUP==3, !is.na(PP07H)) %>% 
  group_by(ANO4,TRIMESTRE) %>% 
  summarise(Protegido = sum(PONDERA[PP07H==1]),
            Desprotegido = sum(PONDERA[PP07H==2]),
            Total = Protegido+Desprotegido,
            Asal.s.descuento = Desprotegido/Total) %>% 
  ggplot(data = ., aes(x =TRIMESTRE,y=Asal.s.descuento))+
    geom_point()+
    geom_line()+
    theme_grey()+
    labs(title = "Asalariados con descuento por trimestre. Año 2016", y= "Tasa de asalariados con descuento")+
    scale_y_continuous(labels = percent)+
    scale_x_continuous(breaks = c(2,3,4))

#Una posible solución, sencilla es crear una variable que combine Año y Trimestre. El problema es que ahí deja de ser numérica la variable. Copio tu código y le modifico algunas cosas

GRANBASE %>% 
  filter(ESTADO==1 ,CAT_OCUP==3, !is.na(PP07H)) %>%
  mutate(periodo = paste0(ANO4,"_",TRIMESTRE)) %>% 
  group_by(periodo) %>% 
  summarise(Protegido = sum(PONDERA[PP07H==1]),
            Desprotegido = sum(PONDERA[PP07H==2]),
            Total = Protegido+Desprotegido,
            Asal.s.descuento = Desprotegido/Total) %>% 
  ggplot(data = ., aes(x =periodo,y=Asal.s.descuento,group = ""))+
    geom_point()+
    geom_line()+
    theme_grey()+
    labs(title = "Asalariados sin descuento por trimestre. Año 2016", y= "Tasa de asalariados con descuento")+
    scale_y_continuous(labels = percent)

#Existen funciones para trabajar con formato fecha, que no vemos en el curso, pero puede realizarse una transformación de la clase de esa variable para que R efectivamente contemple al Año y Trimestre como unidades de tiempo. Chequear paquete "zoo"




```


